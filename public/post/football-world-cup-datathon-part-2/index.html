<!DOCTYPE html>
<html lang="en">
  <head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Football World Cup Datathon - Part 2: Data Aquisition</title>
  <meta property="og:title" content="Football World Cup Datathon - Part 2: Data Aquisition" />
  <meta name="twitter:title" content="Football World Cup Datathon - Part 2: Data Aquisition" />
  <meta name="description" content="I introduced the Betfair World Cup Datathon in Part 1 of this series of posts. In this second post, I’m going to focus on getting data. Given I don’t have a lot of domain knowledge, I can’t go into developing anything too advanced myself. As such, getting as much data as possible is going to be my best bet. This post shows all the data sources I’ve been able to easily access.">
  <meta property="og:description" content="I introduced the Betfair World Cup Datathon in Part 1 of this series of posts. In this second post, I’m going to focus on getting data. Given I don’t have a lot of domain knowledge, I can’t go into developing anything too advanced myself. As such, getting as much data as possible is going to be my best bet. This post shows all the data sources I’ve been able to easily access.">
  <meta name="twitter:description" content="I introduced the Betfair World Cup Datathon in Part 1 of this series of posts. In this second post, I’m going to focus on getting data. Given I don’t have a lot of domain knowledge, I can’t go into …">
  <meta name="author" content="James Day"/>
  <link href='/img/favicon-new.ico' rel='icon' type='image/x-icon'/>
  <meta property="og:image" content="/img/avator-icon-new.png" />
  <meta name="twitter:image" content="/img/avator-icon-new.png" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@plusSixOneblog" />
  <meta name="twitter:creator" content="@plusSixOneblog" />
  <meta property="og:url" content="/post/football-world-cup-datathon-part-2/" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="plusSixOne" />

  <meta name="generator" content="Hugo 0.75.1" />
  <link rel="canonical" href="/post/football-world-cup-datathon-part-2/" />
  <link rel="alternate" href="/index.xml" type="application/rss+xml" title="plusSixOne">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.css" integrity="sha384-wITovz90syo1dJWVh32uuETPVEtGigN07tkttEqPv+uR2SE/mbQcG7ATL28aI9H0" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link rel="stylesheet" href="/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" />
  <link rel="stylesheet" href="/css/codeblock.css" /><link href="//cdn.bootcss.com/highlight.js/9.12.0/styles/atom-one-light.min.css" rel="stylesheet">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">



<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-77406420-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</head>

  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">plusSixOne</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="About" href="/page/about/">About</a>
            </li>
          
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Categories" href="/categories">Categories</a>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">AFL Mens</a>
              <div class="navlinks-children">
                
                  <a href="/page/aflm-predictions">Predictions</a>
                
                  <a href="/page/aflm-games">Current Tips</a>
                
                  <a href="/page/aflm-model-results">Model Results</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
              <a class="navlinks-parent" href="javascript:void(0)">AFL Womens</a>
              <div class="navlinks-children">
                
                  <a href="/page/aflw-coming-soon/">Coming Soon</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="Cool Links" href="/page/cool-links/">Cool Links</a>
            </li>
          
        

        

        
      </ul>
    </div>

    <div class="avatar-container">
      <div class="avatar-img-border">
        
          <a title="plusSixOne" href="/">
            <img class="avatar-img" src="/img/avator-icon-new.png" alt="plusSixOne" />
          </a>
        
      </div>
    </div>

  </div>
</nav>




    
  
  
  




  

  <header class="header-section ">
    
    <div class="intro-header no-img">
      
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              <h1>Football World Cup Datathon - Part 2: Data Aquisition</h1>
                
                
                  <span class="post-meta">
  
  
  <i class="fa fa-calendar-o"></i>&nbsp;Posted on June 11, 2018
  
  
  &nbsp;|&nbsp;
  <i class="fa fa-clock-o"></i> 25 minutes (5217 words)
  
  
</span>


                
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        


<p>I introduced the Betfair World Cup Datathon in <a href="https://plussixoneblog.com/post/football-world-cup-datathon-part-1">Part 1</a> of this series of posts. In this second post, I’m going to focus on getting data. Given I don’t have a lot of domain knowledge, I can’t go into developing anything too advanced myself. As such, getting as much data as possible is going to be my best bet. This post shows all the data sources I’ve been able to easily access.</p>
<pre class="r"><code># Set some defaults and load libraries
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
library(pacman)
pacman::p_load(tidyverse, here, ggthemes, rvest, lubridate)</code></pre>
<div id="load-data" class="section level2">
<h2>Load Data</h2>
<div id="betfair" class="section level3">
<h3>Betfair</h3>
<p>Betfair has provided all participants with data. To get that data you need to sign up to the competition, which you can do <a href="https://www.betfair.com.au/hub/insights/minihubs/world-cup-datathon/">here</a>. I’m also hosting it on Github <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/wc_datathon_dataset.csv">here</a>.</p>
<pre class="r"><code># Load betfair data
betfair_dat &lt;- read_csv(here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;wc_datathon_dataset.csv&quot;))

# View
glimpse(betfair_dat)</code></pre>
<pre><code>## Observations: 14,568
## Variables: 12
## $ date                &lt;date&gt; 2000-06-10, 2000-06-11, 2000-06-11, 2000-...
## $ team_1              &lt;chr&gt; &quot;Belgium&quot;, &quot;France&quot;, &quot;Netherlands&quot;, &quot;Turke...
## $ team_2              &lt;chr&gt; &quot;Sweden&quot;, &quot;Denmark&quot;, &quot;Czech Republic&quot;, &quot;It...
## $ team_1_goals        &lt;int&gt; 2, 3, 1, 1, 1, 3, 3, 0, 0, 3, 1, 0, 0, 1, ...
## $ team_2_goals        &lt;int&gt; 1, 0, 0, 2, 1, 2, 3, 1, 2, 0, 0, 1, 1, 2, ...
## $ tournament          &lt;chr&gt; &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Eu...
## $ is_team_1_home      &lt;lgl&gt; TRUE, FALSE, TRUE, FALSE, FALSE, FALSE, FA...
## $ is_team_2_home      &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, ...
## $ is_neutral          &lt;lgl&gt; FALSE, TRUE, FALSE, TRUE, TRUE, TRUE, TRUE...
## $ team_1_betfair_odds &lt;dbl&gt; 2.72, 1.68, 1.80, 5.90, 2.22, 3.60, 1.76, ...
## $ draw_betfair_odds   &lt;dbl&gt; 2.90, 3.75, 3.45, 3.25, 3.10, 3.10, 3.65, ...
## $ team_2_betfair_odds &lt;dbl&gt; 3.30, 6.60, 5.90, 1.86, 4.20, 2.40, 5.80, ...</code></pre>
<pre class="r"><code>summary(betfair_dat)</code></pre>
<pre><code>##       date               team_1             team_2         
##  Min.   :1998-07-15   Length:14568       Length:14568      
##  1st Qu.:2003-10-11   Class :character   Class :character  
##  Median :2008-06-14   Mode  :character   Mode  :character  
##  Mean   :2008-06-12                                        
##  3rd Qu.:2013-03-22                                        
##  Max.   :2017-11-15                                        
##                                                            
##   team_1_goals     team_2_goals     tournament        is_team_1_home 
##  Min.   : 0.000   Min.   : 0.000   Length:14568       Mode :logical  
##  1st Qu.: 0.000   1st Qu.: 0.000   Class :character   FALSE:2788     
##  Median : 1.000   Median : 1.000   Mode  :character   TRUE :11780    
##  Mean   : 1.608   Mean   : 1.051                                     
##  3rd Qu.: 2.000   3rd Qu.: 2.000                                     
##  Max.   :31.000   Max.   :15.000                                     
##                                                                      
##  is_team_2_home  is_neutral      team_1_betfair_odds draw_betfair_odds
##  Mode :logical   Mode :logical   Min.   :  1.010     Min.   :  1.010  
##  FALSE:14568     FALSE:11800     1st Qu.:  1.460     1st Qu.:  3.350  
##                  TRUE :2768      Median :  2.140     Median :  3.800  
##                                  Mean   :  5.947     Mean   :  6.685  
##                                  3rd Qu.:  3.600     3rd Qu.:  5.300  
##                                  Max.   :980.000     Max.   :980.000  
##                                  NA&#39;s   :5764        NA&#39;s   :5764     
##  team_2_betfair_odds
##  Min.   :   1.01    
##  1st Qu.:   2.30    
##  Median :   4.10    
##  Mean   :  13.28    
##  3rd Qu.:   9.00    
##  Max.   :1000.00    
##  NA&#39;s   :5764</code></pre>
<p>So - it looks like each row is a game that contains the final score, the tournament, who is the home team and then the odds of each outcome. There is quite a lot of games (~14k) which is good! There are some missing values which is a bit annoying but we’ll work out how to deal with that later! I’ll be doing a more detailed data exploration in Part 3.</p>
</div>
<div id="kaggle-odds-dataset" class="section level3">
<h3>Kaggle Odds dataset</h3>
<p>I found this data set on <a href="https://www.kaggle.com/austro/beat-the-bookie-worldwide-football-dataset/data">Kaggle</a> that has the odds for almost 500k matches! Most of those are league games but we should be able to get rid of those when we join it to our other data sets.</p>
<pre class="r"><code># Load odds data
odds_dat &lt;- read_csv(here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;closing_odds.csv&quot;))

# View
glimpse(odds_dat)</code></pre>
<pre><code>## Observations: 479,440
## Variables: 19
## $ match_id            &lt;int&gt; 170088, 170089, 170090, 170091, 170092, 17...
## $ league              &lt;chr&gt; &quot;England: Premier League&quot;, &quot;England: Premi...
## $ match_date          &lt;date&gt; 2005-01-01, 2005-01-01, 2005-01-01, 2005-...
## $ home_team           &lt;chr&gt; &quot;Liverpool&quot;, &quot;Fulham&quot;, &quot;Aston Villa&quot;, &quot;Bol...
## $ home_score          &lt;int&gt; 0, 3, 1, 1, 1, 2, 2, 1, 5, 0, 0, 0, 0, 0, ...
## $ away_team           &lt;chr&gt; &quot;Chelsea&quot;, &quot;Crystal Palace&quot;, &quot;Blackburn&quot;, ...
## $ away_score          &lt;int&gt; 1, 1, 0, 1, 3, 1, 1, 1, 2, 2, 1, 0, 2, 2, ...
## $ avg_odds_home_win   &lt;dbl&gt; 2.9944, 1.9456, 1.8522, 1.6122, 5.9878, 1....
## $ avg_odds_draw       &lt;dbl&gt; 3.1944, 3.2333, 3.2611, 3.4133, 3.4778, 3....
## $ avg_odds_away_win   &lt;dbl&gt; 2.2256, 3.6722, 4.0144, 5.4722, 1.5567, 4....
## $ max_odds_home_win   &lt;dbl&gt; 3.20, 2.04, 2.00, 1.67, 7.00, 1.73, 1.91, ...
## $ max_odds_draw       &lt;dbl&gt; 3.25, 3.30, 3.40, 3.57, 3.60, 3.50, 3.40, ...
## $ max_odds_away_win   &lt;dbl&gt; 2.29, 4.15, 4.50, 6.27, 1.62, 5.00, 4.33, ...
## $ top_bookie_home_win &lt;chr&gt; &quot;Paddy Power&quot;, &quot;Pinnacle Sports&quot;, &quot;Pinnacl...
## $ top_bookie_draw     &lt;chr&gt; &quot;Sportingbet&quot;, &quot;bet-at-home&quot;, &quot;Paddy Power...
## $ top_bookie_away_win &lt;chr&gt; &quot;Expekt&quot;, &quot;Expekt&quot;, &quot;Sportingbet&quot;, &quot;Pinnac...
## $ n_odds_home_win     &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 8, 8, 8, 8, ...
## $ n_odds_draw         &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 8, 8, 8, 8, ...
## $ n_odds_away_win     &lt;int&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 8, 8, 8, 8, ...</code></pre>
<pre class="r"><code>summary(odds_dat)</code></pre>
<pre><code>##     match_id         league            match_date        
##  Min.   :170088   Length:479440      Min.   :2005-01-01  
##  1st Qu.:394532   Class :character   1st Qu.:2009-07-05  
##  Median :566276   Mode  :character   Median :2011-12-17  
##  Mean   :551865                      Mean   :2011-06-19  
##  3rd Qu.:715668                      3rd Qu.:2013-10-08  
##  Max.   :876812                      Max.   :2015-06-30  
##   home_team           home_score       away_team           away_score   
##  Length:479440      Min.   :  0.000   Length:479440      Min.   :  0.0  
##  Class :character   1st Qu.:  1.000   Class :character   1st Qu.:  0.0  
##  Mode  :character   Median :  1.000   Mode  :character   Median :  1.0  
##                     Mean   :  1.539                      Mean   :  1.2  
##                     3rd Qu.:  2.000                      3rd Qu.:  2.0  
##                     Max.   :101.000                      Max.   :102.0  
##  avg_odds_home_win avg_odds_draw    avg_odds_away_win max_odds_home_win
##  Min.   :  0.000   Min.   : 1.010   Min.   :  0.000   Min.   :  0.000  
##  1st Qu.:  1.658   1st Qu.: 3.200   1st Qu.:  2.418   1st Qu.:  1.750  
##  Median :  2.084   Median : 3.361   Median :  3.200   Median :  2.200  
##  Mean   :  2.525   Mean   : 3.670   Mean   :  3.975   Mean   :  2.789  
##  3rd Qu.:  2.643   3rd Qu.: 3.735   3rd Qu.:  4.607   3rd Qu.:  2.850  
##  Max.   :151.000   Max.   :51.000   Max.   :103.024   Max.   :209.040  
##  max_odds_draw     max_odds_away_win top_bookie_home_win
##  Min.   :  1.010   Min.   :  0.000   Length:479440      
##  1st Qu.:  3.300   1st Qu.:  2.580   Class :character   
##  Median :  3.560   Median :  3.500   Mode  :character   
##  Mean   :  3.942   Mean   :  4.573                      
##  3rd Qu.:  4.000   3rd Qu.:  5.200                      
##  Max.   :150.000   Max.   :501.000                      
##  top_bookie_draw    top_bookie_away_win n_odds_home_win  n_odds_draw   
##  Length:479440      Length:479440       Min.   : 0.00   Min.   : 1.00  
##  Class :character   Class :character    1st Qu.: 9.00   1st Qu.: 9.00  
##  Mode  :character   Mode  :character    Median :17.00   Median :17.00  
##                                         Mean   :16.45   Mean   :16.46  
##                                         3rd Qu.:25.00   3rd Qu.:25.00  
##                                         Max.   :29.00   Max.   :29.00  
##  n_odds_away_win
##  Min.   : 0.00  
##  1st Qu.: 9.00  
##  Median :17.00  
##  Mean   :16.45  
##  3rd Qu.:25.00  
##  Max.   :29.00</code></pre>
<p>So this data set has different odds but has it for way more data and nothing missing. One problem I might have is that I’m not sure I can get these specific odds (bookies) easily for the upcoming World Cup games. If I want to include it in a model that will be an issue. I’ll need to see what I can get.</p>
</div>
<div id="fifa" class="section level3">
<h3>FIFA</h3>
<p>Logically, if we wanted to try and assess team ratings we could look towards the official <a href="https://www.fifa.com/fifa-world-ranking/ranking-table/men/index.html">FIFA World rankings</a>. These are used for primarily for seeding in tournaments, such as the World Cup. In researching for this project, I found that these are generally <a href="https://en.wikipedia.org/wiki/FIFA_World_Rankings">critisied for being too simplistic</a> and most people prefer ELO rating systems. Nonetheless, it is a data set I am able to get access to and, given it is used for seeding in the World Cup, there may be some value for including them in a model.</p>
<div id="scraping-data" class="section level4">
<h4>Scraping data</h4>
<p>The code to get this information has been adapted from a <a href="https://github.com/rboberg/rross/blob/master/Soccer/2014/WorldCup/Scrape%20Fifa%20World%20Rankings.R">Github respository</a> I found from Github user <a href="https://github.com/rboberg">Ross Boberg</a>.</p>
<p>If you would prefer to take a scripted version of my code below, you can find that <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/scrape_fifa.R">here</a>. You can also just grab the data directly from <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/fifa_rank_history.csv">here</a>.</p>
<p>Firstly, we have to create a function that builds us a URL. We can then use this to get all the combinations of URLS we need. Based on Ross’ work, we know that each URL contains a query for <code>rank</code>, <code>confediration</code>, <code>gender</code> and <code>page</code>. This function will dynamically generate the URL with the values for those queries.</p>
<p>Now, let’s generate a bunch of URLs. Based on Ross’s code, I know the rough start and end points for <code>rank</code> and I also know the id’s of the <code>confedirations</code>.</p>
<pre class="r"><code># Specify parameters
start_rank = 286 # the last update (as of Jun 5th, 2018)
end_rank = 57 # corresponds to Jan99, when point method was revised
conf_ids = c(23913, 23914, 23915, 23916, 25998, 27275)

rank &lt;- rep(start_rank:end_rank, each = length(conf_ids))
conf_vec &lt;- rep(conf_ids, times = length(start_rank:end_rank))

urls &lt;- rank %&gt;%
  map2_chr(conf_vec, ~ get_ranking_table_URL(rank = .x, confederation = .y))

length(urls)</code></pre>
<pre><code>## [1] 1380</code></pre>
<p>Now we’ve got a list of URLs to search through - I can pass them to <code>read_html</code> and generate local HTML files for me to use. This is the most time consuming part of this process - this function took my laptop ~13 min to run so be mindful if you are following along! I’ve actually just done the first 10 of 1380 for this blog post so comment that out if needed.</p>
<pre class="r"><code># Uncomment 1st line and comment out 2nd line to do all data. I&#39;ve just done 1st 10 for illustration purposes
# ind &lt;- seq_along(urls)
ind &lt;- 1:10 

htmls &lt;- urls[ind] %&gt;%
  map(xml2::read_html)</code></pre>
<p>Success! Now we’ve got those htmls, we can do some extraction and data cleaning. We basically just need to get the dates and then the table of data on each page. Again, using the handy <code>purrr</code> package to do our heavy lifting makes this relatively simple.</p>
<pre class="r"><code># Read date
dates &lt;- htmls %&gt;% 
  map(~html_nodes(.x, &quot;.lb&quot;)) %&gt;%
  map(html_text) %&gt;%
  map_chr(~str_remove(.x, &quot;Last Updated &quot;)) %&gt;%
  map(dmy) 

# Read Tables
tables &lt;- htmls %&gt;% 
  map(~html_nodes(.x, &quot;#tbl_rankingTable&quot;)) %&gt;%
  map(html_table) %&gt;%
  map(as.data.frame)

# Add date, conf id and make into one dataframe
fifa_dat &lt;- tables %&gt;%
  map2(dates, ~ .x %&gt;% mutate(Date = .y)) %&gt;%
  map2(conf_vec[ind], ~ .x %&gt;% mutate(Conference_id = .y)) %&gt;%
  reduce(bind_rows) %&gt;%
  select(Date, Team, Pts, Conference_id) %&gt;%
  arrange(Date, desc(Pts))

head(fifa_dat)</code></pre>
<pre><code>##         Date      Team  Pts Conference_id
## 1 2018-04-12    Brazil 1384         23915
## 2 2018-04-12 Argentina 1254         23915
## 3 2018-04-12     Chile 1146         23915
## 4 2018-04-12      Peru 1106         23915
## 5 2018-04-12   Tunisia 1012         23913
## 6 2018-04-12    Mexico 1008         23914</code></pre>
<p>For the purposes of joining my Data sets, I need the full set of data (the above code is just for the last 10 ratings). <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/fifa_rank_history.csv">Here’s some I prepared earlier!</a>.</p>
<pre class="r"><code>fifa_dat &lt;- read_csv(here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;fifa_rank_history.csv&quot;))
glimpse(fifa_dat)</code></pre>
<pre><code>## Observations: 47,104
## Variables: 4
## $ Date          &lt;date&gt; 1999-01-27, 1999-01-27, 1999-01-27, 1999-01-27,...
## $ Team          &lt;chr&gt; &quot;Brazil&quot;, &quot;France&quot;, &quot;Croatia&quot;, &quot;Italy&quot;, &quot;Germany...
## $ Pts           &lt;int&gt; 829, 787, 745, 745, 742, 733, 726, 720, 703, 698...
## $ Conference_id &lt;int&gt; 23915, 27275, 27275, 27275, 27275, 23915, 27275,...</code></pre>
<pre class="r"><code>summary(fifa_dat)</code></pre>
<pre><code>##       Date                Team                Pts         Conference_id  
##  Min.   :1999-01-27   Length:47104       Min.   :   0.0   Min.   :23913  
##  1st Qu.:2003-12-15   Class :character   1st Qu.: 162.0   1st Qu.:23913  
##  Median :2008-10-08   Mode  :character   Median : 360.0   Median :23916  
##  Mean   :2008-09-24                      Mean   : 397.3   Mean   :25221  
##  3rd Qu.:2013-08-08                      3rd Qu.: 568.0   3rd Qu.:27275  
##  Max.   :2018-05-17                      Max.   :1920.0   Max.   :27275</code></pre>
</div>
</div>
<div id="other-sources" class="section level3">
<h3>Other sources</h3>
<p>I had looked at some other sources but found it either too tricky or they didn’t have wide enough covered. These including trying to include ‘team value’ information from Transfermarkt. I think this would be awesome but I could only get the value of each of the current World Cup squads. I’m sure it’s possible to try and find backdate information but I don’t have the time.</p>
<p>Another option that would be cool would be to use the EA Sports FIFA player ratings as a bit of a proxy for the talent in each team. I did find some promising websites but they were ultimately going to take too much time to scrape.</p>
</div>
</div>
<div id="combining-dataset" class="section level1">
<h1>Combining dataset</h1>
<p>Now that we have acquired our data, we need to combine it in some way to make one big data file. Again, I want this to be one row per match and it’s going to be fairly wide.</p>
<p>Now, what we want is to add the FIFA data to our betfair odds. This isn’t going to a simple join I don’t think - we want to match the home team name and the date of the match to the closest date and team in our FIFA file and return the rating. I’m pretty sure that the FIFA ratings get updated once per month so we may be able to join on <code>year</code>, <code>month</code> and <code>team</code></p>
<pre class="r"><code># Add in a date/month to fifa and betfair data
fifa_dat &lt;- fifa_dat %&gt;%
  mutate(year = year(Date),
         month = month(Date)) %&gt;%
  select(year, month, Team, Pts) 

betfair_dat &lt;- betfair_dat %&gt;%
  mutate(year = year(date),
         month = month(date))

odds_dat &lt;- odds_dat %&gt;%
  select(match_id, match_date, home_team, away_team, avg_odds_home_win:avg_odds_away_win)

# Join data together
dat &lt;- betfair_dat %&gt;%
  left_join(fifa_dat, by = c(&quot;year&quot;, &quot;month&quot;, &quot;team_1&quot; = &quot;Team&quot;)) %&gt;%
  rename(team_1_fifa = Pts) %&gt;%
  left_join(fifa_dat, by = c(&quot;year&quot;, &quot;month&quot;, &quot;team_2&quot; = &quot;Team&quot;)) %&gt;%
  rename(team_2_fifa = Pts) %&gt;%
  left_join(odds_dat, by = c(&quot;date&quot; = &quot;match_date&quot;, &quot;team_1&quot; = &quot;home_team&quot;, &quot;team_2&quot; = &quot;away_team&quot;))

head(dat)</code></pre>
<pre><code>## # A tibble: 6 x 20
##   date       team_1      team_2       team_1_goals team_2_goals tournament
##   &lt;date&gt;     &lt;chr&gt;       &lt;chr&gt;               &lt;int&gt;        &lt;int&gt; &lt;chr&gt;     
## 1 2000-06-10 Belgium     Sweden                  2            1 Euro 2000 
## 2 2000-06-11 France      Denmark                 3            0 Euro 2000 
## 3 2000-06-11 Netherlands Czech Repub…            1            0 Euro 2000 
## 4 2000-06-11 Turkey      Italy                   1            2 Euro 2000 
## 5 2000-06-12 Germany     Romania                 1            1 Euro 2000 
## 6 2000-06-12 Portugal    England                 3            2 Euro 2000 
## # ... with 14 more variables: is_team_1_home &lt;lgl&gt;, is_team_2_home &lt;lgl&gt;,
## #   is_neutral &lt;lgl&gt;, team_1_betfair_odds &lt;dbl&gt;, draw_betfair_odds &lt;dbl&gt;,
## #   team_2_betfair_odds &lt;dbl&gt;, year &lt;dbl&gt;, month &lt;dbl&gt;, team_1_fifa &lt;int&gt;,
## #   team_2_fifa &lt;int&gt;, match_id &lt;int&gt;, avg_odds_home_win &lt;dbl&gt;,
## #   avg_odds_draw &lt;dbl&gt;, avg_odds_away_win &lt;dbl&gt;</code></pre>
<pre class="r"><code>glimpse(dat)</code></pre>
<pre><code>## Observations: 14,730
## Variables: 20
## $ date                &lt;date&gt; 2000-06-10, 2000-06-11, 2000-06-11, 2000-...
## $ team_1              &lt;chr&gt; &quot;Belgium&quot;, &quot;France&quot;, &quot;Netherlands&quot;, &quot;Turke...
## $ team_2              &lt;chr&gt; &quot;Sweden&quot;, &quot;Denmark&quot;, &quot;Czech Republic&quot;, &quot;It...
## $ team_1_goals        &lt;int&gt; 2, 3, 1, 1, 1, 3, 3, 0, 0, 3, 1, 0, 0, 1, ...
## $ team_2_goals        &lt;int&gt; 1, 0, 0, 2, 1, 2, 3, 1, 2, 0, 0, 1, 1, 2, ...
## $ tournament          &lt;chr&gt; &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Eu...
## $ is_team_1_home      &lt;lgl&gt; TRUE, FALSE, TRUE, FALSE, FALSE, FALSE, FA...
## $ is_team_2_home      &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, ...
## $ is_neutral          &lt;lgl&gt; FALSE, TRUE, FALSE, TRUE, TRUE, TRUE, TRUE...
## $ team_1_betfair_odds &lt;dbl&gt; 2.72, 1.68, 1.80, 5.90, 2.22, 3.60, 1.76, ...
## $ draw_betfair_odds   &lt;dbl&gt; 2.90, 3.75, 3.45, 3.25, 3.10, 3.10, 3.65, ...
## $ team_2_betfair_odds &lt;dbl&gt; 3.30, 6.60, 5.90, 1.86, 4.20, 2.40, 5.80, ...
## $ year                &lt;dbl&gt; 2000, 2000, 2000, 2000, 2000, 2000, 2000, ...
## $ month               &lt;dbl&gt; 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, ...
## $ team_1_fifa         &lt;int&gt; 585, 758, 629, 568, 706, 647, NA, 728, 585...
## $ team_2_fifa         &lt;int&gt; 646, 662, 750, 660, 692, 682, 538, 703, 66...
## $ match_id            &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ avg_odds_home_win   &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ avg_odds_draw       &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ avg_odds_away_win   &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...</code></pre>
<pre class="r"><code>summary(dat)</code></pre>
<pre><code>##       date               team_1             team_2         
##  Min.   :1998-07-15   Length:14730       Length:14730      
##  1st Qu.:2003-10-12   Class :character   Class :character  
##  Median :2008-06-22   Mode  :character   Mode  :character  
##  Mean   :2008-06-19                                        
##  3rd Qu.:2013-02-06                                        
##  Max.   :2017-11-15                                        
##                                                            
##   team_1_goals     team_2_goals    tournament        is_team_1_home 
##  Min.   : 0.000   Min.   : 0.00   Length:14730       Mode :logical  
##  1st Qu.: 0.000   1st Qu.: 0.00   Class :character   FALSE:2810     
##  Median : 1.000   Median : 1.00   Mode  :character   TRUE :11920    
##  Mean   : 1.603   Mean   : 1.05                                     
##  3rd Qu.: 2.000   3rd Qu.: 2.00                                     
##  Max.   :31.000   Max.   :15.00                                     
##                                                                     
##  is_team_2_home  is_neutral      team_1_betfair_odds draw_betfair_odds
##  Mode :logical   Mode :logical   Min.   :  1.010     Min.   :  1.010  
##  FALSE:14730     FALSE:11940     1st Qu.:  1.460     1st Qu.:  3.350  
##                  TRUE :2790      Median :  2.140     Median :  3.800  
##                                  Mean   :  5.892     Mean   :  6.647  
##                                  3rd Qu.:  3.600     3rd Qu.:  5.300  
##                                  Max.   :980.000     Max.   :980.000  
##                                  NA&#39;s   :5791        NA&#39;s   :5791     
##  team_2_betfair_odds      year          month         team_1_fifa    
##  Min.   :   1.01     Min.   :1998   Min.   : 1.000   Min.   :   0.0  
##  1st Qu.:   2.32     1st Qu.:2003   1st Qu.: 4.000   1st Qu.: 333.0  
##  Median :   4.10     Median :2008   Median : 7.000   Median : 515.0  
##  Mean   :  13.18     Mean   :2008   Mean   : 6.728   Mean   : 536.1  
##  3rd Qu.:   9.00     3rd Qu.:2013   3rd Qu.:10.000   3rd Qu.: 683.8  
##  Max.   :1000.00     Max.   :2017   Max.   :12.000   Max.   :1887.0  
##  NA&#39;s   :5791                                        NA&#39;s   :1412    
##   team_2_fifa        match_id      avg_odds_home_win avg_odds_draw   
##  Min.   :   0.0   Min.   :173540   Min.   : 1.010    Min.   : 1.737  
##  1st Qu.: 326.0   1st Qu.:337465   1st Qu.: 1.422    1st Qu.: 3.207  
##  Median : 503.0   Median :464972   Median : 2.035    Median : 3.491  
##  Mean   : 522.9   Mean   :496687   Mean   : 3.418    Mean   : 4.423  
##  3rd Qu.: 659.0   3rd Qu.:653966   3rd Qu.: 3.153    3rd Qu.: 4.527  
##  Max.   :1920.0   Max.   :876298   Max.   :60.687    Max.   :32.230  
##  NA&#39;s   :1429     NA&#39;s   :9722     NA&#39;s   :9722      NA&#39;s   :9722    
##  avg_odds_away_win
##  Min.   :  1.010  
##  1st Qu.:  2.215  
##  Median :  3.526  
##  Mean   :  6.195  
##  3rd Qu.:  7.170  
##  Max.   :103.024  
##  NA&#39;s   :9722</code></pre>
<p>It seems promising at first glance but there are missing FIFA rankings which shouldn’t happen.</p>
<pre class="r"><code>matched &lt;- dat %&gt;%
  group_by(team_1) %&gt;%
  summarise(match = sum(!is.na(team_1_fifa)),
            no_match = sum(is.na(team_1_fifa))) %&gt;%
  mutate(perc = match/(match + no_match)) %&gt;%
  arrange(perc)

matched %&gt;%
  filter(perc == 0) %&gt;%
  arrange(desc(no_match))</code></pre>
<pre><code>## # A tibble: 30 x 4
##    team_1             match no_match  perc
##    &lt;chr&gt;              &lt;int&gt;    &lt;int&gt; &lt;dbl&gt;
##  1 China                  0      140    0.
##  2 Ireland                0      122    0.
##  3 Ivory Coast            0       98    0.
##  4 Macedonia              0       92    0.
##  5 Bosnia-Herzegovina     0       81    0.
##  6 Cape Verde             0       45    0.
##  7 Burma                  0       36    0.
##  8 Curacao                0       22    0.
##  9 Martinique             0       22    0.
## 10 Guadeloupe             0       17    0.
## # ... with 20 more rows</code></pre>
<p>So - there are only 30 countries that don’t match at all. Most of those are really small countries, or countries that have changed names. China is a weird one to be missing. Let’s see what we can find in the FIFA data set.</p>
<pre class="r"><code>fifa_dat %&gt;%
  filter(str_detect(Team, &quot;China&quot;))</code></pre>
<pre><code>## # A tibble: 230 x 4
##     year month Team       Pts
##    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;    &lt;int&gt;
##  1 1999.    1. China PR   513
##  2 1999.    2. China PR   511
##  3 1999.    3. China PR   510
##  4 1999.    4. China PR   509
##  5 1999.    5. China PR   507
##  6 1999.    6. China PR   505
##  7 1999.    7. China PR   502
##  8 1999.    8. China PR   499
##  9 1999.    9. China PR   497
## 10 1999.   10. China PR   494
## # ... with 220 more rows</code></pre>
<pre class="r"><code>betfair_dat %&gt;%
  filter(str_detect(team_1, &quot;China&quot;))</code></pre>
<pre><code>## # A tibble: 140 x 14
##    date       team_1 team_2    team_1_goals team_2_goals tournament       
##    &lt;date&gt;     &lt;chr&gt;  &lt;chr&gt;            &lt;int&gt;        &lt;int&gt; &lt;chr&gt;            
##  1 2002-06-04 China  Costa Ri…            0            2 World Cup 2002   
##  2 2003-02-12 China  Brazil               0            0 Friendly         
##  3 2003-08-20 China  Chile                0            0 Friendly         
##  4 2004-06-01 China  Hungary              2            1 Friendly         
##  5 2004-06-09 China  Malaysia             4            0 World Cup 2006 Q…
##  6 2004-07-17 China  Bahrain              2            2 Asian Cup 2004   
##  7 2004-07-21 China  Indonesia            5            0 Asian Cup 2004   
##  8 2004-07-25 China  Qatar                1            0 Asian Cup 2004   
##  9 2004-07-30 China  Iraq                 3            0 Asian Cup 2004   
## 10 2004-08-03 China  Iran                 1            1 Asian Cup 2004   
## # ... with 130 more rows, and 8 more variables: is_team_1_home &lt;lgl&gt;,
## #   is_team_2_home &lt;lgl&gt;, is_neutral &lt;lgl&gt;, team_1_betfair_odds &lt;dbl&gt;,
## #   draw_betfair_odds &lt;dbl&gt;, team_2_betfair_odds &lt;dbl&gt;, year &lt;dbl&gt;,
## #   month &lt;dbl&gt;</code></pre>
<pre class="r"><code>fifa_dat %&gt;%
  filter(str_detect(Team, &quot;Ireland&quot;))</code></pre>
<pre><code>## # A tibble: 450 x 4
##     year month Team                  Pts
##    &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;               &lt;int&gt;
##  1 1999.    1. Republic of Ireland   535
##  2 1999.    1. Northern Ireland      467
##  3 1999.    2. Republic of Ireland   550
##  4 1999.    2. Northern Ireland      465
##  5 1999.    3. Republic of Ireland   547
##  6 1999.    3. Northern Ireland      463
##  7 1999.    4. Republic of Ireland   540
##  8 1999.    4. Northern Ireland      459
##  9 1999.    5. Republic of Ireland   557
## 10 1999.    5. Northern Ireland      455
## # ... with 440 more rows</code></pre>
<pre class="r"><code>betfair_dat %&gt;%
  filter(str_detect(team_1, &quot;Ireland&quot;))</code></pre>
<pre><code>## # A tibble: 204 x 14
##    date       team_1  team_2    team_1_goals team_2_goals tournament      
##    &lt;date&gt;     &lt;chr&gt;   &lt;chr&gt;            &lt;int&gt;        &lt;int&gt; &lt;chr&gt;           
##  1 2001-06-02 Ireland Portugal             1            1 World Cup 2002 …
##  2 2001-11-10 Ireland Iran                 2            0 World Cup 2002 …
##  3 2002-04-17 Ireland USA                  2            1 Friendly        
##  4 2002-06-01 Ireland Cameroon             1            1 World Cup 2002  
##  5 2003-06-07 Ireland Albania              2            1 Euro 2004 Quali…
##  6 2003-09-06 Ireland Russia               1            1 Euro 2004 Quali…
##  7 2004-02-18 Ireland Brazil               0            0 Friendly        
##  8 2004-03-31 Ireland Czech Re…            2            1 Friendly        
##  9 2004-05-27 Ireland Romania              1            0 Friendly        
## 10 2004-05-29 Ireland Nigeria              0            3 Friendly        
## # ... with 194 more rows, and 8 more variables: is_team_1_home &lt;lgl&gt;,
## #   is_team_2_home &lt;lgl&gt;, is_neutral &lt;lgl&gt;, team_1_betfair_odds &lt;dbl&gt;,
## #   draw_betfair_odds &lt;dbl&gt;, team_2_betfair_odds &lt;dbl&gt;, year &lt;dbl&gt;,
## #   month &lt;dbl&gt;</code></pre>
<p>Hmm - so it didn’t join because the FIFA data using “China PR”. Also, it didn’t match Northern Ireland or Republic of Ireland. I’m guessing that is the case for the rest of these 172 countries as well. I really should explore doing some fuzzy matching but it’s only a small group and most of those teams aren’t featuring in many matches so I’m just going to do it for the top 5. I manually worked out what these differences were.</p>
<pre class="r"><code>fix_teams &lt;- function(team){
    case_when(
      team == &quot;China PR&quot; ~ &quot;China&quot;,
      team == &quot;Republic of Ireland&quot; ~ &quot;Ireland&quot;,
      team == &quot;Côte d&#39;Ivoire&quot; ~ &quot;Ivory Coast&quot;,
      team == &quot;FYR Macedonia&quot; ~ &quot;Macedonia&quot;,
      team == &quot;Bosnia and Herzegovina&quot; ~ &quot;Bosnia-Herzegovina&quot;,
      TRUE ~ team
    )
}

fifa_dat &lt;- fifa_dat %&gt;%
  mutate(Team = fix_teams(Team))</code></pre>
<p>OK - that should at least pick the top 5. Those smaller teams I’ll just have to not have any FIFA data. I suspect, given those level of teams aren’t appearing in World Cups, that we won’t have a big issue. The other missing data, since we matched the name properly at least once, are likely due to some kind of missing month/year combination, which I can deal with later.</p>
<pre class="r"><code># Join data together
dat &lt;- betfair_dat %&gt;%
  left_join(fifa_dat, by = c(&quot;year&quot;, &quot;month&quot;, &quot;team_1&quot; = &quot;Team&quot;)) %&gt;%
  rename(team_1_fifa = Pts) %&gt;%
  left_join(fifa_dat, by = c(&quot;year&quot;, &quot;month&quot;, &quot;team_2&quot; = &quot;Team&quot;)) %&gt;%
  rename(team_2_fifa = Pts) %&gt;%
  left_join(odds_dat, by = c(&quot;date&quot; = &quot;match_date&quot;, &quot;team_1&quot; = &quot;home_team&quot;, &quot;team_2&quot; = &quot;away_team&quot;))

head(dat)</code></pre>
<pre><code>## # A tibble: 6 x 20
##   date       team_1      team_2       team_1_goals team_2_goals tournament
##   &lt;date&gt;     &lt;chr&gt;       &lt;chr&gt;               &lt;int&gt;        &lt;int&gt; &lt;chr&gt;     
## 1 2000-06-10 Belgium     Sweden                  2            1 Euro 2000 
## 2 2000-06-11 France      Denmark                 3            0 Euro 2000 
## 3 2000-06-11 Netherlands Czech Repub…            1            0 Euro 2000 
## 4 2000-06-11 Turkey      Italy                   1            2 Euro 2000 
## 5 2000-06-12 Germany     Romania                 1            1 Euro 2000 
## 6 2000-06-12 Portugal    England                 3            2 Euro 2000 
## # ... with 14 more variables: is_team_1_home &lt;lgl&gt;, is_team_2_home &lt;lgl&gt;,
## #   is_neutral &lt;lgl&gt;, team_1_betfair_odds &lt;dbl&gt;, draw_betfair_odds &lt;dbl&gt;,
## #   team_2_betfair_odds &lt;dbl&gt;, year &lt;dbl&gt;, month &lt;dbl&gt;, team_1_fifa &lt;int&gt;,
## #   team_2_fifa &lt;int&gt;, match_id &lt;int&gt;, avg_odds_home_win &lt;dbl&gt;,
## #   avg_odds_draw &lt;dbl&gt;, avg_odds_away_win &lt;dbl&gt;</code></pre>
<pre class="r"><code>glimpse(dat)</code></pre>
<pre><code>## Observations: 14,740
## Variables: 20
## $ date                &lt;date&gt; 2000-06-10, 2000-06-11, 2000-06-11, 2000-...
## $ team_1              &lt;chr&gt; &quot;Belgium&quot;, &quot;France&quot;, &quot;Netherlands&quot;, &quot;Turke...
## $ team_2              &lt;chr&gt; &quot;Sweden&quot;, &quot;Denmark&quot;, &quot;Czech Republic&quot;, &quot;It...
## $ team_1_goals        &lt;int&gt; 2, 3, 1, 1, 1, 3, 3, 0, 0, 3, 1, 0, 0, 1, ...
## $ team_2_goals        &lt;int&gt; 1, 0, 0, 2, 1, 2, 3, 1, 2, 0, 0, 1, 1, 2, ...
## $ tournament          &lt;chr&gt; &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Euro 2000&quot;, &quot;Eu...
## $ is_team_1_home      &lt;lgl&gt; TRUE, FALSE, TRUE, FALSE, FALSE, FALSE, FA...
## $ is_team_2_home      &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, ...
## $ is_neutral          &lt;lgl&gt; FALSE, TRUE, FALSE, TRUE, TRUE, TRUE, TRUE...
## $ team_1_betfair_odds &lt;dbl&gt; 2.72, 1.68, 1.80, 5.90, 2.22, 3.60, 1.76, ...
## $ draw_betfair_odds   &lt;dbl&gt; 2.90, 3.75, 3.45, 3.25, 3.10, 3.10, 3.65, ...
## $ team_2_betfair_odds &lt;dbl&gt; 3.30, 6.60, 5.90, 1.86, 4.20, 2.40, 5.80, ...
## $ year                &lt;dbl&gt; 2000, 2000, 2000, 2000, 2000, 2000, 2000, ...
## $ month               &lt;dbl&gt; 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, ...
## $ team_1_fifa         &lt;int&gt; 585, 758, 629, 568, 706, 647, NA, 728, 585...
## $ team_2_fifa         &lt;int&gt; 646, 662, 750, 660, 692, 682, 538, 703, 66...
## $ match_id            &lt;int&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ avg_odds_home_win   &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ avg_odds_draw       &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...
## $ avg_odds_away_win   &lt;dbl&gt; NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA...</code></pre>
<pre class="r"><code>summary(dat)</code></pre>
<pre><code>##       date               team_1             team_2         
##  Min.   :1998-07-15   Length:14740       Length:14740      
##  1st Qu.:2003-10-12   Class :character   Class :character  
##  Median :2008-06-22   Mode  :character   Mode  :character  
##  Mean   :2008-06-20                                        
##  3rd Qu.:2013-02-06                                        
##  Max.   :2017-11-15                                        
##                                                            
##   team_1_goals     team_2_goals    tournament        is_team_1_home 
##  Min.   : 0.000   Min.   : 0.00   Length:14740       Mode :logical  
##  1st Qu.: 0.000   1st Qu.: 0.00   Class :character   FALSE:2814     
##  Median : 1.000   Median : 1.00   Mode  :character   TRUE :11926    
##  Mean   : 1.603   Mean   : 1.05                                     
##  3rd Qu.: 2.000   3rd Qu.: 2.00                                     
##  Max.   :31.000   Max.   :15.00                                     
##                                                                     
##  is_team_2_home  is_neutral      team_1_betfair_odds draw_betfair_odds
##  Mode :logical   Mode :logical   Min.   :  1.010     Min.   :  1.010  
##  FALSE:14740     FALSE:11946     1st Qu.:  1.460     1st Qu.:  3.350  
##                  TRUE :2794      Median :  2.140     Median :  3.800  
##                                  Mean   :  5.887     Mean   :  6.645  
##                                  3rd Qu.:  3.600     3rd Qu.:  5.300  
##                                  Max.   :980.000     Max.   :980.000  
##                                  NA&#39;s   :5791        NA&#39;s   :5791     
##  team_2_betfair_odds      year          month         team_1_fifa  
##  Min.   :   1.01     Min.   :1998   Min.   : 1.000   Min.   :   0  
##  1st Qu.:   2.32     1st Qu.:2003   1st Qu.: 4.000   1st Qu.: 339  
##  Median :   4.10     Median :2008   Median : 7.000   Median : 517  
##  Mean   :  13.17     Mean   :2008   Mean   : 6.725   Mean   : 538  
##  3rd Qu.:   9.00     3rd Qu.:2013   3rd Qu.:10.000   3rd Qu.: 685  
##  Max.   :1000.00     Max.   :2017   Max.   :12.000   Max.   :1887  
##  NA&#39;s   :5791                                        NA&#39;s   :901   
##   team_2_fifa        match_id      avg_odds_home_win avg_odds_draw   
##  Min.   :   0.0   Min.   :173540   Min.   : 1.010    Min.   : 1.737  
##  1st Qu.: 331.0   1st Qu.:337483   1st Qu.: 1.421    1st Qu.: 3.207  
##  Median : 506.0   Median :464970   Median : 2.035    Median : 3.492  
##  Mean   : 525.6   Mean   :496636   Mean   : 3.419    Mean   : 4.423  
##  3rd Qu.: 662.0   3rd Qu.:653965   3rd Qu.: 3.154    3rd Qu.: 4.527  
##  Max.   :1920.0   Max.   :876298   Max.   :60.687    Max.   :32.230  
##  NA&#39;s   :996      NA&#39;s   :9728     NA&#39;s   :9728      NA&#39;s   :9728    
##  avg_odds_away_win
##  Min.   :  1.010  
##  1st Qu.:  2.215  
##  Median :  3.526  
##  Mean   :  6.196  
##  3rd Qu.:  7.183  
##  Max.   :103.024  
##  NA&#39;s   :9728</code></pre>
</div>
<div id="submission" class="section level1">
<h1>Submission</h1>
<p>One of the important things is getting a good submission file in the right format. There is no point building a big model with heaps of variables and then not having those variables available for our actual submission!</p>
<p>Luckily, Betfair has given us a starting point with the matches we need to predict. Let’s load that file in (I’m hosting it <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/john_smith_numbersman.csv">here</a> if you want it.)</p>
<pre class="r"><code>world_cup &lt;- read_csv(here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;john_smith_numbersman.csv&quot;))
glimpse(world_cup)</code></pre>
<pre><code>## Observations: 48
## Variables: 7
## $ date             &lt;chr&gt; &quot;14/06/2018&quot;, &quot;15/06/2018&quot;, &quot;15/06/2018&quot;, &quot;15...
## $ match_id         &lt;chr&gt; &quot;a_1&quot;, &quot;a_2&quot;, &quot;b_1&quot;, &quot;b_2&quot;, &quot;c_1&quot;, &quot;d_1&quot;, &quot;c_...
## $ team_1           &lt;chr&gt; &quot;russia&quot;, &quot;egypt&quot;, &quot;morocco&quot;, &quot;portugal&quot;, &quot;fr...
## $ team_2           &lt;chr&gt; &quot;saudi arabia&quot;, &quot;uruguay&quot;, &quot;iran&quot;, &quot;spain&quot;, &quot;...
## $ prob_team_1_win  &lt;dbl&gt; 0.42, 0.20, 0.20, 0.20, 0.80, 0.82, 0.42, 0.6...
## $ prob_team_1_draw &lt;dbl&gt; 0.32, 0.30, 0.48, 0.45, 0.12, 0.10, 0.32, 0.1...
## $ prob_team_1_lose &lt;dbl&gt; 0.26, 0.50, 0.32, 0.35, 0.08, 0.08, 0.26, 0.2...</code></pre>
<p>First thing that jumps out is that the team’s are in lower case. I’ll need to fix that. Also, the date isn’t being read properly. Lastly, those probability columns are just examples from Betfair so I can get rid of those.</p>
<pre class="r"><code>world_cup &lt;- world_cup %&gt;%
  mutate(date = dmy(date)) %&gt;%
  mutate_at(vars(team_1, team_2), tools::toTitleCase) %&gt;%
  select(date, match_id, team_1, team_2)</code></pre>
<p>Now the other fields that we don’t have are <code>tournament</code>, <code>is_team_1_home</code>, <code>is_team_2_home</code> and <code>is_neutral</code>. We can also hopefully get the <code>betfair</code> odds and the <code>fifa</code> points.</p>
<pre class="r"><code># Add extra columns
world_cup &lt;- world_cup %&gt;%
  mutate(
    tournament = &quot;World Cup 2018&quot;,
    is_team_1_home = ifelse(team_1 == &quot;Russia&quot;, TRUE, FALSE),
    is_team_2_home = ifelse(team_2 == &quot;Russia&quot;, TRUE, FALSE),
    is_neutral = !is_team_1_home &amp; !is_team_2_home,
    year = year(date),
    month = month(date)
    )

# Join with fifa
fifa_dat_final &lt;- fifa_dat %&gt;% 
  group_by(Team) %&gt;% 
  filter(row_number() == n()) %&gt;%
  select(Team, Pts)

world_cup &lt;- world_cup %&gt;%
  left_join(fifa_dat_final, by = c(&quot;team_1&quot; = &quot;Team&quot;)) %&gt;%
  rename(team_1_fifa = Pts) %&gt;%
  left_join(fifa_dat_final, by = c(&quot;team_2&quot; = &quot;Team&quot;)) %&gt;%
  rename(team_2_fifa = Pts)</code></pre>
<p>I’ve also used the betfair API to get the betfair data. I haven’t included the code for that as it uses login details, but you can see my script <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/betfair_api.R">here</a> or just load the data from <a href="https://github.com/jimmyday12/plussixoneblog/blob/master/projects/world-cup-2018/world_cup_2018_betfair.csv">here</a>.</p>
<p>Let’s load that in and join it to our existing world cup data frame.</p>
<pre class="r"><code>betfair_wc &lt;- read_csv(here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;world_cup_2018_betfair.csv&quot;))

world_cup &lt;- world_cup %&gt;%
  left_join(betfair_wc, by = c(&quot;date&quot;, &quot;team_1&quot;, &quot;team_2&quot;))
glimpse(world_cup)</code></pre>
<pre><code>## Observations: 48
## Variables: 15
## $ date                &lt;date&gt; 2018-06-14, 2018-06-15, 2018-06-15, 2018-...
## $ match_id            &lt;chr&gt; &quot;a_1&quot;, &quot;a_2&quot;, &quot;b_1&quot;, &quot;b_2&quot;, &quot;c_1&quot;, &quot;d_1&quot;, ...
## $ team_1              &lt;chr&gt; &quot;Russia&quot;, &quot;Egypt&quot;, &quot;Morocco&quot;, &quot;Portugal&quot;, ...
## $ team_2              &lt;chr&gt; &quot;Saudi Arabia&quot;, &quot;Uruguay&quot;, &quot;Iran&quot;, &quot;Spain&quot;...
## $ tournament          &lt;chr&gt; &quot;World Cup 2018&quot;, &quot;World Cup 2018&quot;, &quot;World...
## $ is_team_1_home      &lt;lgl&gt; TRUE, FALSE, FALSE, FALSE, FALSE, FALSE, F...
## $ is_team_2_home      &lt;lgl&gt; FALSE, FALSE, FALSE, FALSE, FALSE, FALSE, ...
## $ is_neutral          &lt;lgl&gt; FALSE, TRUE, TRUE, TRUE, TRUE, TRUE, TRUE,...
## $ year                &lt;dbl&gt; 2018, 2018, 2018, 2018, 2018, 2018, 2018, ...
## $ month               &lt;dbl&gt; 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, ...
## $ team_1_fifa         &lt;int&gt; 493, 636, 681, 1306, 1166, 1254, 1106, 975...
## $ team_2_fifa         &lt;int&gt; 462, 976, 798, 1162, 700, 930, 1054, 635, ...
## $ draw_betfair_odds   &lt;dbl&gt; 4.60, 3.80, 3.05, 3.50, 7.00, 5.30, 3.35, ...
## $ team_1_betfair_odds &lt;dbl&gt; 1.47, 7.80, 2.38, 4.80, 1.27, 1.35, 3.30, ...
## $ team_2_betfair_odds &lt;dbl&gt; 10.00, 1.65, 4.00, 1.99, 14.50, 15.00, 2.4...</code></pre>
</div>
<div id="finishing-up" class="section level1">
<h1>Finishing up</h1>
<p>Anyway, enough for now. Let’s save it and we’ll revisit in Part 3!</p>
<pre class="r"><code>write_csv(dat, here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;combined-data.csv&quot;))
write_csv(world_cup, here::here(&quot;projects&quot;, &quot;world-cup-2018&quot;, &quot;world-cup.csv&quot;))</code></pre>
<p>I’ve done the models and submitted to Betfair - you can see those here. I’ll post up my actual model write up tomorrow after the first game!</p>
<p><a href="https://plussixoneblog.com/page/project-world-cup-datathon/">Project Page</a><br />
<a href="https://plussixoneblog.com/post/football-world-cup-datathon-part-1">Part 1 - Intro</a><br />
<a href="https://plussixoneblog.com/post/football-world-cup-datathon-part-2">Part 2 - Data Acquisition</a><br />
<a href="https://plussixoneblog.com/post/football-world-cup-datathon-part-3">Part 3 - Data Exploration and Feature Engineering</a><br />
<a href="https://plussixoneblog.com/post/football-world-cup-datathon-part-4">Part 4 - Models (coming soon)</a><br />
Part 5 - Review (coming soon)</p>
</div>

      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="/post/football-world-cup-datathon-part-1/" data-toggle="tooltip" data-placement="top" title="Football World Cup Datathon - Part 1: Intro">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="/post/world-cup-datathon-part-3/" data-toggle="tooltip" data-placement="top" title="World Cup Datathon - Part 3: Feature Engineering">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "plussixone" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
        
        
      

    </div>
  </div>
</div>

    <footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:jamesthomasday@gmail.com" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://www.facebook.com/plussixoneblog" title="Facebook">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-facebook fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/jimmyday12" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/plusSixOneblog" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/james-day-ab648321" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fa fa-circle fa-stack-2x"></i>
                    <i class="fa fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            
            <a href="/index.xml" title="RSS">
            
              <span class="fa-stack fa-lg">
                <i class="fa fa-circle fa-stack-2x"></i>
                <i class="fa fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              <a href="plussixoneblog.com">James Day</a>
            
          

          &nbsp;&bull;&nbsp;
          2020

          
            &nbsp;&bull;&nbsp;
            <a href="/">plusSixOne</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="http://gohugo.io">Hugo v0.75.1</a> powered &nbsp;&bull;&nbsp; Theme by <a href="http://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a> adapted to <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a>
          
        </p>
      </div>
    </div>
  </div>
  

</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/katex.min.js" integrity="sha384-/y1Nn9+QQAipbNQWU65krzJralCnuOasHncUFXGkdwntGeSvQicrYkiUBwsgUqc1" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.7.1/contrib/auto-render.min.js" integrity="sha384-dq1/gEHSxPZQ7DdrM82ID4YVol9BYyU7GbWlIwnwyPzotpoc57wDw/guX8EaYGPx" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
<script src="/js/main.js"></script>

<script> renderMathInElement(document.body); </script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script>
<script src="/js/load-photoswipe.js"></script>









<script src="//cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
<script src="//cdn.bootcss.com/highlight.js/9.12.0/languages/r.min.js"></script>

<script>
hljs.configure({languages: []});
hljs.initHighlightingOnLoad();
</script>

  </body>
</html>

